<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Chat to n8n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 50px;
      background-color: #f9f9f9;
    }

    #controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      color: white;
    }

    #recordButton {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: red;
      position: relative;
      font-size: 16px;
    }

    #recordButton.recording::after {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 2px solid red;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.2); opacity: 0.3; }
      100% { transform: scale(1); opacity: 0.7; }
    }

    #timer {
      font-size: 18px;
      margin-top: 10px;
    }

    #chat {
      width: 500px;
      max-height: 450px;
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow-y: auto;
      padding: 15px;
      background-color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .message {
      margin: 10px 0;
      padding: 12px 15px;
      border-radius: 10px;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.5;
      max-width: 85%;
    }

    .user {
      background-color: #daf1fc;
      text-align: right;
      align-self: flex-end;
    }

    .bot {
      background-color: #f1f1f1;
      text-align: left;
      align-self: flex-start;
    }

    .bot div {
      margin: 4px 0;
    }
    .bot strong {
      color: #333;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="recordButton">Record</button>
    <input type="file" id="uploadAudio" accept="audio/*">
  </div>
  <div id="timer">00:00</div>
  <div id="chat"></div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    const recordButton = document.getElementById('recordButton');
    const uploadAudio = document.getElementById('uploadAudio');
    const chat = document.getElementById('chat');
    const timerEl = document.getElementById('timer');

    let recording = false;
    let timerInterval;
    let seconds = 0;

    function updateTimer() {
      seconds++;
      const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
      const secs = String(seconds % 60).padStart(2, '0');
      timerEl.textContent = `${mins}:${secs}`;
    }

    function resetTimer() {
      clearInterval(timerInterval);
      seconds = 0;
      timerEl.textContent = '00:00';
    }

    // Record button click
    recordButton.addEventListener('click', async () => {
      if (uploadAudio.files.length > 0) return; // ไม่ให้ record ถ้ามีไฟล์อัพโหลด

      if (!recording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", async () => {
          resetTimer();
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

          // ดาวน์โหลดไฟล์ลงเครื่อง
          const url = URL.createObjectURL(audioBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `voice_${Date.now()}.webm`;
          a.click();

          addMessage('User sent voice message...', 'user');

          // ส่งไป n8n
          const formData = new FormData();
          formData.append('file', audioBlob, 'voice.webm');

          try {
            const response = await fetch('https://pb-n8n.planbmedia.co.th/webhook/voice', {
              method: 'POST',
              body: formData
            });

            let data = await response.json();
            let message = '';

            if (Array.isArray(data) && data[0]?.output) {
              message = data[0].output;
            } else if (data.text) {
              message = data.text;
            } else if (typeof data === 'string') {
              try {
                const parsed = JSON.parse(data);
                message = parsed.text || parsed.output || JSON.stringify(parsed);
              } catch (e) {
                message = data;
              }
            } else {
              message = JSON.stringify(data);
            }

            addMessageStructured(message, 'bot');

          } catch (err) {
            console.error(err);
            addMessage('Error sending to n8n', 'bot');
          }
        });

        mediaRecorder.start();
        recording = true;
        recordButton.classList.add('recording');
        recordButton.textContent = 'Stop';

        // เริ่มจับเวลา
        seconds = 0;
        timerEl.textContent = '00:00';
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        mediaRecorder.stop();
        recording = false;
        recordButton.classList.remove('recording');
        recordButton.textContent = 'Record';
      }
    });

    // Upload file
    uploadAudio.addEventListener('change', () => {
      if (uploadAudio.files.length > 0) {
        recordButton.disabled = true;
        addMessage(`User uploaded file: ${uploadAudio.files[0].name}`, 'user');
        // คุณสามารถส่งไฟล์ upload ไป n8n เหมือน record ได้
      } else {
        recordButton.disabled = false;
      }
    });

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.innerHTML = text.replace(/\n/g, '<br>');
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addMessageStructured(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      const lines = text.split('\n');
      const html = lines.map(line => {
        const parts = line.split(':');
        if (parts.length >= 2) {
          const label = parts[0].trim();
          const value = parts.slice(1).join(':').trim();
          return `<div><strong>${label}:</strong> ${value}</div>`;
        } else {
          return `<div>${line}</div>`;
        }
      }).join('');
      div.innerHTML = html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
