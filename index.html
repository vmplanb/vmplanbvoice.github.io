<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Voice ‚Üí n8n (Session + Polling)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#f3f5f7; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --primary:#2563eb;
  --good:#16a34a; --warn:#f59e0b; --danger:#dc2626;
}
body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:var(--text);}
.container{max-width:760px;margin:32px auto;padding:0 16px;}
.card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px;}
h1{margin:0 0 8px 0;font-size:24px;}
.sub{color:var(--muted);font-size:14px;margin-bottom:16px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.pill{font-size:13px;color:#111;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:6px 10px}
.controls{display:flex;gap:16px;flex-wrap:wrap;margin:14px 0}
button{border:0;border-radius:14px;padding:14px 18px;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn-rec{background:#ef4444;color:#fff}
.btn-rec:hover:not(.btn-disabled){background:#dc2626}
.btn-stop{background:#f59e0b;color:#fff}
.btn-stop:hover:not(.btn-disabled){background:#d97706}
.btn-upload{background:var(--primary);color:#fff}
.btn-upload:hover:not(.btn-disabled){background:#1d4ed8}
.btn-disabled{opacity:.5;pointer-events:none}
.timer{font-variant-numeric:tabular-nums;font-weight:700}
.status{margin:8px 0 0 0;font-size:14px}
.status-good{color:var(--good)} .status-warn{color:var(--warn)} .status-bad{color:var(--danger)}
.spinner{display:none;align-items:center;gap:8px;margin-top:8px;color:var(--muted);font-weight:600}
.spinner-dot{width:8px;height:8px;border-radius:50%;background:#9ca3af;animation:blink 1.2s infinite ease-in-out}
.spinner-dot:nth-child(2){animation-delay:.2s}.spinner-dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
.chat{margin-top:16px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding:4px}
.msg{padding:12px 14px;border-radius:12px;line-height:1.5;white-space:pre-wrap;max-width:85%}
.me{align-self:flex-end;background:#dbeafe;color:#1e40af}
.bot{align-self:flex-start;background:#f3f4f6;color:#374151}
.session{font-size:12px;color:var(--muted);user-select:all}
.inline-note{font-size:12px;color:var(--muted)}
input[type=file]{display:none}
.init-warning{background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;padding:12px;margin-bottom:16px;font-size:14px;color:#92400e}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>üé§ Voice ‚Üí n8n (Session + Polling)</h1>
    <div class="sub">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ n8n ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢ <code>sessionId</code></div>

    <div id="initWarning" class="init-warning" style="display:none">
      ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    </div>

    <div class="row">
      <span class="pill session" id="sessionIdPill">sessionId: ‚Äî</span>
      <span class="pill"><span class="timer" id="timer">00:00 / 05:00</span></span>
      <span class="pill inline-note">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: MP3 / WAV / OGG (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)</span>
    </div>

    <div class="controls">
      <button id="btnRecord" class="btn-rec">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
      <button id="btnStop" class="btn-stop btn-disabled">‡∏´‡∏¢‡∏∏‡∏î & ‡∏™‡πà‡∏á</button>
      <input id="fileInput" type="file" accept="audio/*" />
      <button id="btnUpload" class="btn-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
    </div>

    <div id="status" class="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
    <div id="spinner" class="spinner"><span class="spinner-dot"></span><span class="spinner-dot"></span><span class="spinner-dot"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å n8n‚Ä¶</div>

    <div class="chat" id="chat"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<script>
const UPLOAD_URL = "https://pb-n8n.planbmedia.co.th/webhook/voice";
const RESULT_URL = "https://pb-n8n.planbmedia.co.th/webhook/return";

const sessionId = "sess-" + Date.now() + "-" + Math.random().toString(36).slice(2, 8);
document.getElementById("sessionIdPill").textContent = "sessionId: " + sessionId;

const btnRecord = document.getElementById('btnRecord');
const btnStop = document.getElementById('btnStop');
const btnUpload = document.getElementById('btnUpload');
const fileInput = document.getElementById('fileInput');
const timerEl = document.getElementById('timer');
const statusEl = document.getElementById('status');
const spinnerEl = document.getElementById('spinner');
const chat = document.getElementById('chat');
const initWarning = document.getElementById('initWarning');

const SUPPORTED_UPLOAD = ['audio/mpeg','audio/mp3','audio/wav','audio/ogg'];
const MAX_SEC = 300;
let mediaRecorder, audioChunks = [], recording = false, startTime, timerInt, pollInt;

// ====== AudioContext ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ user interaction ======
let audioContext = null;
let audioInitialized = false;

const initAudioContext = async () => {
  // ‡∏´‡∏≤‡∏Å audioContext ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  if (!audioContext || audioContext.state === 'closed') {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log('AudioContext created.');
    } catch (e) {
      console.error('Audio context initialization failed:', e);
      setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ', 'bad');
      return false;
    }
  }

  // ‡∏´‡∏≤‡∏Å audioContext ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ suspended ‡πÉ‡∏´‡πâ resume
  if (audioContext.state === 'suspended') {
    try {
      await audioContext.resume();
      console.log('AudioContext resumed.');
    } catch (e) {
      console.error('Audio context resume failed:', e);
      setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ', 'bad');
      return false;
    }
  }

  // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ audioContext ‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  audioInitialized = true;
  initWarning.style.display = 'none';
  setStatus('‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'good');
  return true;
};

const setStatus = (msg,type='') => {
  statusEl.className='status';
  if(type==='good') statusEl.classList.add('status-good');
  if(type==='warn') statusEl.classList.add('status-warn');
  if(type==='bad') statusEl.classList.add('status-bad');
  statusEl.textContent=msg;
};

const showSpinner = show => spinnerEl.style.display = show?'flex':'none';

const addMsg = (text, who='me')=>{
  const div=document.createElement('div');
  div.className=`msg ${who}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
};

// ====== ‡πÅ‡∏õ‡∏•‡∏á JSON ‡πÄ‡∏õ‡πá‡∏ô human-readable format ======
const formatResponse = (data) => {
  if (typeof data === 'string') {
    return data;
  }
  
  if (Array.isArray(data)) {
    return data.map(item => {
      if (typeof item === 'object' && item.output) {
        return formatResponse(item.output);
      }
      return formatResponse(item);
    }).join('\n\n');
  }
  
  if (typeof data === 'object' && data !== null) {
    // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å object
    if (data.text) {
      return data.text;
    }
    if (data.transcription || data.transcript) {
      return data.transcription || data.transcript;
    }
    if (data.result) {
      return formatResponse(data.result);
    }
    if (data.response) {
      return formatResponse(data.response);
    }
    if (data.message) {
      return data.message;
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á object ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô readable format
    const entries = Object.entries(data)
      .filter(([key, value]) => value !== null && value !== undefined && value !== '')
      .map(([key, value]) => {
        const cleanKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        if (typeof value === 'object') {
          return `${cleanKey}: ${formatResponse(value)}`;
        }
        return `${cleanKey}: ${value}`;
      });
    
    return entries.length > 0 ? entries.join('\n') : JSON.stringify(data, null, 2);
  }
  
  return String(data);
};

const fmt = s => String(s).padStart(2,'0');

// ====== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ======
btnRecord.addEventListener('click', async ()=>{
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ init audio
  if (!audioInitialized) {
    initWarning.style.display = 'block';
  }
  
  if (!(await initAudioContext())) return;
  
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) audioChunks.push(e.data); };

    mediaRecorder.onstop = async ()=>{
      // ‡∏´‡∏¢‡∏∏‡∏î stream
      stream.getTracks().forEach(track => track.stop());
      
      clearInterval(timerInt);
      timerEl.textContent="00:00 / 05:00";
      const webmBlob = new Blob(audioChunks,{type:'audio/webm'});
      
      try {
        const mp3Blob = await webmToMp3(webmBlob);
        addMsg(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î ~${(mp3Blob.size/1024/1024).toFixed(2)} MB`,'me');

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        const a = document.createElement('a');
        a.href = URL.createObjectURL(mp3Blob);
        a.download = `recording-${Date.now()}.mp3`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },100);

        await sendToN8n(mp3Blob,'recording.mp3');
      } catch (conversionError) {
        console.error('MP3 conversion failed:', conversionError);
        setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô MP3 ‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö...', 'warn');
        addMsg(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‚Ä¢ ‡∏Ç‡∏ô‡∏≤ÿØ ~${(webmBlob.size/1024/1024).toFixed(2)} MB (WebM)`,'me');
        await sendToN8n(webmBlob,'recording.webm');
      }
    };

    mediaRecorder.start();
    recording = true;
    btnRecord.classList.add('btn-disabled');
    btnStop.classList.remove('btn-disabled');
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‚Ä¶ ‡∏Å‡∏î "‡∏´‡∏¢‡∏∏‡∏î & ‡∏™‡πà‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ n8n','warn');

    startTime = Date.now();
    timerInt = setInterval(()=>{
      const elapsed = Math.floor((Date.now()-startTime)/1000);
      timerEl.textContent = `${fmt(Math.floor(elapsed/60))}:${fmt(elapsed%60)} / 05:00`;
      if(elapsed>=MAX_SEC){
        mediaRecorder.stop();
        recording=false;
        btnRecord.classList.remove('btn-disabled');
        btnStop.classList.add('btn-disabled');
        setStatus('‡∏Ñ‡∏£‡∏ö 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‚Ä¶','warn');
      }
    },250);

  }catch(e){
    console.error('Recording failed:', e);
    setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô','bad');
  }
});

// ====== ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ======
btnStop.addEventListener('click', ()=>{
  if(recording && mediaRecorder){
    mediaRecorder.stop();
    recording=false;
    btnRecord.classList.remove('btn-disabled');
    btnStop.classList.add('btn-disabled');
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ n8n‚Ä¶','warn');
  }
});

// ====== Upload ======
btnUpload.addEventListener('click', async () => {
  if (!(await initAudioContext())) return;
  fileInput.click();
});

fileInput.addEventListener('change',async e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  if(!SUPPORTED_UPLOAD.includes(f.type)){
    setStatus('‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ MP3 / WAV / OGG','bad');
    return;
  }
  addMsg(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`,'me');
  await sendToN8n(f,f.name);
  fileInput.value='';
});

// ====== ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå + Poll ======
async function sendToN8n(blob, filename){
  try{
    showSpinner(true);
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á n8n‚Ä¶','warn');
    
    const form = new FormData();
    form.append('file',blob,filename);
    form.append('sessionId',sessionId);
    
    const res = await fetch(UPLOAD_URL,{
      method:'POST',
      body:form
    });
    
    if(!res.ok){ 
      const errorText = await res.text().catch(() => '');
      setStatus(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: HTTP ${res.status} ${errorText}`,'bad'); 
      showSpinner(false); 
      return; 
    }
    
    setStatus('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Ä¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‚Ä¶','good');

    let waited = 0;
    const maxWait = 180000; // 3 minutes
    
    pollInt && clearInterval(pollInt);
    pollInt = setInterval(async ()=>{
      try{
        const q = new URLSearchParams({sessionId});
        const r = await fetch(`${RESULT_URL}?${q.toString()}`, {
          method:'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });
        
        if(r.status === 204){ 
          waited += 2000; 
          if(waited >= maxWait){
            clearInterval(pollInt); 
            showSpinner(false); 
            setStatus('‡∏£‡∏≠‡∏ú‡∏•‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (3 ‡∏ô‡∏≤‡∏ó‡∏µ) ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á','bad');
          }
          return; 
        }
        
        if(!r.ok){ 
          clearInterval(pollInt); 
          showSpinner(false); 
          const errorText = await r.text().catch(() => '');
          setStatus(`‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: HTTP ${r.status} ${errorText}`,'bad'); 
          return; 
        }
        
        const data = await r.json();
        clearInterval(pollInt); 
        showSpinner(false); 
        setStatus('‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','good');
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
        const humanReadable = formatResponse(data);
        addMsg(humanReadable, 'bot');
        
      }catch(e){ 
        console.error('Polling error:', e);
        clearInterval(pollInt); 
        showSpinner(false); 
        setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','bad'); 
      }
    }, 2000);

  }catch(err){ 
    console.error('Send error:', err);
    showSpinner(false); 
    setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ n8n','bad'); 
  }
}

// ====== WebM ‚Üí MP3 ======
async function webmToMp3(webmBlob){
  try {
    const ab = await webmBlob.arrayBuffer();
    const audioBuf = await audioContext.decodeAudioData(ab);
    const mp3encoder = new lamejs.Mp3Encoder(audioBuf.numberOfChannels, audioBuf.sampleRate, 128);
    
    const samples = audioBuf.getChannelData(0);
    const blockSize = 1152;
    const mp3data = [];
    
    for(let i = 0; i < samples.length; i += blockSize){
      const chunk = samples.subarray(i, i + blockSize);
      const mp3buf = mp3encoder.encodeBuffer(floatTo16bitPCM(chunk));
      if(mp3buf.length > 0) mp3data.push(mp3buf);
    }
    
    const end = mp3encoder.flush();
    if(end.length > 0) mp3data.push(end);
    
    return new Blob(mp3data, {type:'audio/mpeg'});
  } catch (error) {
    console.error('MP3 encoding failed:', error);
    throw error;
  }
}

function floatTo16bitPCM(input){
  const out = new Int16Array(input.length);
  for(let i = 0; i < input.length; i++){
    let s = Math.max(-1, Math.min(1, input[i]));
    out[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
  }
  return out;
}

// ====== ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô initial ======
window.addEventListener('load', () => {
  setTimeout(() => {
    if (!audioInitialized) {
      initWarning.style.display = 'block';
    }
  }, 1000);
});
</script>
</body>
</html>
