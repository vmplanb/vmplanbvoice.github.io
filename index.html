<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Meeting Voice Upload</title>
</head>
<body>
  <h2>üìå Meeting Voice Upload</h2>
  
  <form id="meetingForm">
    <label>ID: <input type="text" id="userId" required></label><br><br>
    <label>Name: <input type="text" id="userName" required></label><br><br>
    <label>Email: <input type="email" id="userEmail" required></label><br><br>

    <button type="button" id="startBtn">Start Recording</button>
    <button type="button" id="stopBtn" disabled>Stop</button><br><br>
    <audio id="player" controls></audio><br><br>

    <button type="submit">Submit to n8n</button>
  </form>

  <script>
    let recorder, chunks = [];
    let audioBlob = null;

    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const player   = document.getElementById("player");
    const form     = document.getElementById("meetingForm");

    // ‡πÉ‡∏™‡πà URL Webhook ‡∏Ç‡∏≠‡∏á n8n
    const webhookUrl = "https://pb-n8n.planbmedia.co.th/webhook-test/voice";

    // Start Recording
    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.onstop = () => {
          audioBlob = new Blob(chunks, { type: "audio/webm" });
          player.src = URL.createObjectURL(audioBlob);
        };

        recorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        console.log("Recording started...");
      } catch(err) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ: " + err.message);
        console.error(err);
      }
    };

    // Stop Recording
    stopBtn.onclick = () => {
      recorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      console.log("Recording stopped.");
    };

    // Submit Form
    form.onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById("userId").value.trim();
      const name = document.getElementById("userName").value.trim();
      const email = document.getElementById("userEmail").value.trim();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Email ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ @planbmedia.co.th
      if(!email.endsWith("@planbmedia.co.th")){
        alert("Email ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ @planbmedia.co.th");
        return;
      }

      if(!audioBlob){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
        return;
      }

      const fd = new FormData();
      fd.append("ID", id);
      fd.append("Name", name);
      fd.append("Email", email);
      fd.append("file", audioBlob, "meeting_recording.webm");

      try {
        const res = await fetch(webhookUrl, {
          method: "POST",
          body: fd
        });
        if(res.ok){
          alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          form.reset();
          player.src = "";
          audioBlob = null;
        } else {
          alert("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }
      } catch(err){
        console.error(err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }
    };
  </script>
</body>
</html>
