<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Meeting Voice Upload</title>
  <style>
    #recordingIndicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: red;
      margin-left: 10px;
      visibility: hidden;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <h2>üìå Meeting Voice Upload</h2>

  <form id="meetingForm">
    <label>ID: <input type="text" id="userId" required></label><br><br>
    <label>Name: <input type="text" id="userName" required></label><br><br>
    <label>Email: <input type="email" id="userEmail" required></label><br><br>

    <button type="button" id="startBtn">Start Recording</button>
    <span id="recordingIndicator"></span><br><br>

    <label>Or upload audio file: <input type="file" id="uploadFile" accept="audio/*"></label><br><br>

    <audio id="player" controls></audio><br><br>

    <button type="submit">Save and Submit</button>
  </form>

  <script>
    let recorder, chunks = [];
    let audioBlob = null;
    let stream = null;
    let isRecording = false;
    let isUploadedFile = false;

    const startBtn = document.getElementById("startBtn");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const player = document.getElementById("player");
    const uploadFile = document.getElementById("uploadFile");
    const form = document.getElementById("meetingForm");

    const webhookUrl = "https://pb-n8n.planbmedia.co.th/webhook-test/voice";

    // Start Recording
    startBtn.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        chunks = [];
        isRecording = true;
        isUploadedFile = false;

        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.onstop = () => {
          audioBlob = new Blob(chunks, { type: "audio/webm" });
          player.src = URL.createObjectURL(audioBlob);
          isRecording = false;
        };

        recorder.start();
        startBtn.disabled = true;
        recordingIndicator.style.visibility = "visible";
        console.log("Recording started...");
      } catch(err) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ: " + err.message);
        console.error(err);
      }
    };

    // Upload file event
    uploadFile.onchange = (e) => {
      const file = e.target.files[0];
      if(file){
        audioBlob = file;
        player.src = URL.createObjectURL(file);
        isUploadedFile = true;
        // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á record ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        if(isRecording && recorder){
          recorder.stop();
          stream.getTracks().forEach(track => track.stop());
          recordingIndicator.style.visibility = "hidden";
        }
        startBtn.disabled = false;
      }
    };

    // Submit Form
    form.onsubmit = async (e) => {
      e.preventDefault();

      const id = document.getElementById("userId").value.trim();
      const name = document.getElementById("userName").value.trim();
      const email = document.getElementById("userEmail").value.trim();

      if(!email.endsWith("@planbmedia.co.th")){
        alert("Email ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ @planbmedia.co.th");
        return;
      }

      // ‡∏ñ‡πâ‡∏≤ Record ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
      if(isRecording && recorder){
        recorder.stop();
        recordingIndicator.style.visibility = "hidden";
        stream.getTracks().forEach(track => track.stop());
        await new Promise(resolve => {
          recorder.onstop = () => {
            audioBlob = new Blob(chunks, { type: "audio/webm" });
            player.src = URL.createObjectURL(audioBlob);
            isRecording = false;
            resolve();
          };
        });
      }

      if(!audioBlob){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
        return;
      }

      // Save local ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏á
      if(!isUploadedFile){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(audioBlob);
        a.download = "meeting_recording.webm";
        a.click();
      }

      // ‡∏™‡πà‡∏á‡πÑ‡∏õ n8n
      const fd = new FormData();
      fd.append("ID", id);
      fd.append("Name", name);
      fd.append("Email", email);
      fd.append("file", audioBlob, "meeting_recording.webm");

      try {
        const res = await fetch(webhookUrl, { method: "POST", body: fd });
        if(res.ok){
          alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ n8n ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
          form.reset();
          player.src = "";
          audioBlob = null;
          isUploadedFile = false;
          startBtn.disabled = false;
        } else {
          alert("‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        }
      } catch(err){
        console.error(err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }
    };
  </script>
</body>
</html>
