<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Voice ‚Üí n8n (Session + Polling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f3f5f7; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --primary:#2563eb;
      --good:#16a34a; --warn:#f59e0b; --danger:#dc2626;
    }
    body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:var(--text);}
    .container{max-width:760px;margin:32px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px;}
    h1{margin:0 0 8px 0;font-size:24px;}
    .sub{color:var(--muted);font-size:14px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{font-size:13px;color:#111;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:6px 10px}
    .controls{display:flex;gap:16px;flex-wrap:wrap;margin:14px 0}
    button{border:0;border-radius:14px;padding:14px 18px;font-weight:600;cursor:pointer}
    .btn-rec{background:#ef4444;color:#fff}
    .btn-stop{background:#f59e0b;color:#fff}
    .btn-upload{background:var(--primary);color:#fff}
    .btn-disabled{opacity:.5;pointer-events:none}
    .timer{font-variant-numeric:tabular-nums;font-weight:700}
    .support{color:var(--muted);font-size:13px}
    .status{margin:8px 0 0 0;font-size:14px}
    .status-good{color:var(--good)} .status-warn{color:var(--warn)} .status-bad{color:var(--danger)}
    .spinner{display:none;align-items:center;gap:8px;margin-top:8px;color:var(--muted);font-weight:600}
    .spinner-dot{width:8px;height:8px;border-radius:50%;background:#9ca3af;animation:blink 1.2s infinite ease-in-out}
    .spinner-dot:nth-child(2){animation-delay:.2s}.spinner-dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
    .chat{margin-top:16px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto}
    .msg{padding:12px 14px;border-radius:12px;line-height:1.5;white-space:pre-wrap}
    .me{align-self:flex-end;background:#dbeafe}
    .bot{align-self:flex-start;background:#f3f4f6}
    .kv div{margin:3px 0}
    .kv strong{color:#111}
    .session{font-size:12px;color:var(--muted);user-select:all}
    .inline-note{font-size:12px;color:var(--muted)}
    input[type=file]{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üé§ Voice ‚Üí n8n (Session + Polling)</h1>
      <div class="sub">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ n8n ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢ <code>sessionId</code></div>

      <div class="row">
        <span class="pill session" id="sessionIdPill">sessionId: ‚Äî</span>
        <span class="pill"><span class="timer" id="timer">00:00 / 05:00</span></span>
        <span class="pill inline-note">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: MP3 / WAV / OGG (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)</span>
      </div>

      <div class="controls">
        <button id="btnRecord" class="btn-rec">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button id="btnStop" class="btn-stop btn-disabled">‡∏´‡∏¢‡∏∏‡∏î & ‡∏™‡πà‡∏á</button>
        <input id="fileInput" type="file" accept="audio/*" />
        <button id="btnUpload" class="btn-upload">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
      </div>

      <div id="status" class="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
      <div id="spinner" class="spinner"><span class="spinner-dot"></span><span class="spinner-dot"></span><span class="spinner-dot"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏≤‡∏Å n8n‚Ä¶</div>

      <div class="chat" id="chat"></div>
    </div>
  </div>

  <!-- MP3 encoder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
  <script>
    // ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á n8n (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ======
    const UPLOAD_URL = "https://pb-n8n.planbmedia.co.th/webhook/voice";   // Webhook A (Respond Immediately)
    const RESULT_URL = "https://pb-n8n.planbmedia.co.th/webhook/return";     // Webhook B (Polling)

    // ====== ‡∏™‡∏£‡πâ‡∏≤‡∏á sessionId ‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡πÅ‡∏ó‡πá‡∏ö ======
    const sessionId = "sess-" + Date.now() + "-" + Math.random().toString(36).slice(2, 8);
    document.getElementById("sessionIdPill").textContent = "sessionId: " + sessionId;

    // ====== UI refs ======
    const btnRecord = document.getElementById('btnRecord');
    const btnStop = document.getElementById('btnStop');
    const btnUpload = document.getElementById('btnUpload');
    const fileInput = document.getElementById('fileInput');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');
    const spinnerEl = document.getElementById('spinner');
    const chat = document.getElementById('chat');

    // ====== State ======
    const SUPPORTED_UPLOAD = ['audio/mpeg','audio/mp3','audio/wav','audio/ogg']; // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î
    const MAX_SEC = 300; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
    let mediaRecorder, audioChunks = [], recording = false, startTime, timerInt, pollInt;
    let audioContext;

    // ====== Helpers ======
    const setStatus = (msg, type='') => {
      statusEl.className = 'status';
      if(type==='good') statusEl.classList.add('status-good');
      if(type==='warn') statusEl.classList.add('status-warn');
      if(type==='bad')  statusEl.classList.add('status-bad');
      statusEl.textContent = msg;
    };
    const showSpinner = (show) => spinnerEl.style.display = show ? 'flex' : 'none';

    const addMsg = (html, who='me') => {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.innerHTML = html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    };

    // ====== ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤
    const addStructured = (text, who='bot') => {
      if(!text) return;
      // ‡∏ñ‡πâ‡∏≤ text ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡∏Å‡πà‡∏≠‡∏ô
      if(Array.isArray(text)){
        text = text.map(t=>t.output||'').join('\n');
      }
    
      const lines = text.split('\n');
      const html = lines.map(line=>{
        const parts = line.split(':');
        if(parts.length >= 2){
          return `<div><strong>${parts[0].trim()}:</strong> ${parts.slice(1).join(':').trim()}</div>`;
        }
        return `<div>${line}</div>`;
      }).join('');
    
      const box = document.createElement('div');
      box.className = `msg ${who} kv`;
      box.innerHTML = html;
      chat.appendChild(box);
      chat.scrollTop = chat.scrollHeight;
    };
    
    // ====== Recording ======
    mediaRecorder.onstop = async () => {
      clearInterval(timerInt);
      timerEl.textContent = "00:00 / 05:00";
      // ‡πÅ‡∏õ‡∏•‡∏á WebM ‚Üí MP3 ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
      const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const mp3Blob = await webmToMp3(webmBlob);
      addMsg(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î ~${(mp3Blob.size/1024/1024).toFixed(2)} MB`,'me');
    
      // ----- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -----
      const a = document.createElement('a');
      const url = URL.createObjectURL(mp3Blob);
      a.href = url;
      a.download = 'recording.mp3';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    
      await sendToN8n(mp3Blob, 'recording.mp3');
    };

    const fmt = s => String(s).padStart(2,'0');

    // ====== Recording ======
    btnRecord.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };

        mediaRecorder.onstop = async () => {
          clearInterval(timerInt);
          timerEl.textContent = "00:00 / 05:00";
          // ‡πÅ‡∏õ‡∏•‡∏á WebM ‚Üí MP3 ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
          const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const mp3Blob = await webmToMp3(webmBlob);
          addMsg(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î ~${(mp3Blob.size/1024/1024).toFixed(2)} MB`,'me');
          await sendToN8n(mp3Blob, 'recording.mp3');
        };

        mediaRecorder.start();
        recording = true;
        btnRecord.classList.add('btn-disabled');
        btnStop.classList.remove('btn-disabled');
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‚Ä¶ ‡∏Å‡∏î "‡∏´‡∏¢‡∏∏‡∏î & ‡∏™‡πà‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ n8n', 'warn');

        startTime = Date.now();
        timerInt = setInterval(()=>{
          const elapsed = Math.floor((Date.now()-startTime)/1000);
          timerEl.textContent = `${fmt(Math.floor(elapsed/60))}:${fmt(elapsed%60)} / 05:00`;
          if(elapsed >= MAX_SEC){
            mediaRecorder.stop();
            recording=false;
            btnRecord.classList.remove('btn-disabled');
            btnStop.classList.add('btn-disabled');
            setStatus('‡∏Ñ‡∏£‡∏ö 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‚Ä¶', 'warn');
          }
        }, 250);
      } catch (e) {
        setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ', 'bad');
      }
    });

    btnStop.addEventListener('click', () => {
      if(recording && mediaRecorder){
        mediaRecorder.stop();
        recording = false;
        btnRecord.classList.remove('btn-disabled');
        btnStop.classList.add('btn-disabled');
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ n8n‚Ä¶', 'warn');
      }
    });

    // ====== Upload ======
    btnUpload.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      if(!SUPPORTED_UPLOAD.includes(f.type)){
        setStatus('‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ MP3 / WAV / OGG', 'bad');
        return;
      }
      addMsg(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ${f.name}`,'me');
      await sendToN8n(f, f.name);
      fileInput.value = '';
    });

    // ====== ‡∏™‡πà‡∏á‡πÑ‡∏õ n8n (Webhook A) + Poll (Webhook B) ======
    async function sendToN8n(blob, filename){
      try{
        showSpinner(true);
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á n8n‚Ä¶', 'warn');

        const form = new FormData();
        form.append('file', blob, filename);
        form.append('sessionId', sessionId);

        // Webhook A: Respond Immediately (‡∏à‡∏∞‡πÑ‡∏î‡πâ {"status":"processing"} ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        const res = await fetch(UPLOAD_URL, { method:'POST', body: form });
        if(!res.ok){
          setStatus(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: HTTP ${res.status}`, 'bad');
          showSpinner(false);
          return;
        }
        // ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô body ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô processing ‡πÅ‡∏ï‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ debug
        let ack = {};
        try { ack = await res.json(); } catch {}
        setStatus('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Ä¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‚Ä¶', 'good');

        // ‡πÄ‡∏£‡∏¥‡πà‡∏° Polling (‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ô‡∏≤‡∏ó‡∏µ)
        let waited = 0;
        pollInt && clearInterval(pollInt);
        pollInt = setInterval(async ()=>{
          try{
            const q = new URLSearchParams({ sessionId });
            const r = await fetch(`${RESULT_URL}?${q.toString()}`, { method:'GET' });
            if(r.status === 204){ // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•
              waited += 2000;
              if(waited >= 180000){ // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
                clearInterval(pollInt);
                showSpinner(false);
                setStatus('‡∏£‡∏≠‡∏ú‡∏•‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á', 'bad');
              }
              return;
            }
            if(!r.ok){
              clearInterval(pollInt);
              showSpinner(false);
              setStatus(`‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: HTTP ${r.status}`, 'bad');
              return;
            }
            const data = await r.json();
            clearInterval(pollInt);
            showSpinner(false);
            setStatus('‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'good');

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢ ‡πÜ
            if(data?.text){
              addStructured(data.text, 'bot');
            }else{
              addMsg(JSON.stringify(data, null, 2), 'bot');
            }
          }catch(e){
            clearInterval(pollInt);
            showSpinner(false);
            setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏∂‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', 'bad');
          }
        }, 2000);

      }catch(err){
        showSpinner(false);
        setStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ n8n', 'bad');
      }
    }

    // ====== ‡πÅ‡∏õ‡∏•‡∏á WebM ‚Üí MP3 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) ======
    async function webmToMp3(webmBlob){
      const ab = await webmBlob.arrayBuffer();
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const audioBuf = await audioContext.decodeAudioData(ab);

      const mp3encoder = new lamejs.Mp3Encoder(audioBuf.numberOfChannels, audioBuf.sampleRate, 128);
      const samples = audioBuf.getChannelData(0);        // mono ‡∏à‡∏≤‡∏Å ch0 (‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö STT)
      const blockSize = 1152;
      const mp3data = [];
      for(let i=0;i<samples.length;i+=blockSize){
        const chunk = samples.subarray(i, i+blockSize);
        const mp3buf = mp3encoder.encodeBuffer(floatTo16bitPCM(chunk));
        if(mp3buf.length>0) mp3data.push(mp3buf);
      }
      const end = mp3encoder.flush();
      if(end.length>0) mp3data.push(end);
      return new Blob(mp3data, { type:'audio/mpeg' });
    }

    function floatTo16bitPCM(input){
      const out = new Int16Array(input.length);
      for(let i=0;i<input.length;i++){
        let s = Math.max(-1, Math.min(1, input[i]));
        out[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
      }
      return out;
    }
  </script>
</body>
</html>
