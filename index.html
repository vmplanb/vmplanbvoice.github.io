<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meeting Voice Upload</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    display: flex;
    justify-content: center;
    padding: 40px;
  }
  .card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    width: 450px;
  }
  h2 { text-align: center; color: #333; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; }
  button {
    margin-top: 15px;
    width: 100%; padding: 12px;
    border: none; border-radius: 10px;
    font-size: 16px; cursor: pointer;
  }
  .recording { background: #e74c3c; color: white; animation: pulse 1.2s infinite; }
  .normal { background: #3498db; color: white; }
  .submit { background: #2ecc71; color: white; }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); }
    70% { box-shadow: 0 0 0 12px rgba(231,76,60,0); }
    100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); }
  }
  audio { margin-top: 15px; width: 100%; }
  #status { margin-top: 10px; text-align: center; color: #555; }
</style>
</head>
<body>
<div class="card">
  <h2>üìå Meeting Voice Upload</h2>
  <form id="meetingForm">
    <label>ID</label><input type="text" id="userId" required>
    <label>Name</label><input type="text" id="userName" required>
    <label>Email</label><input type="email" id="userEmail" required placeholder="example@planbmedia.co.th">
    <label>Record Voice</label>
    <button type="button" id="recordBtn" class="normal">üéô Start Recording</button>
    <audio id="player" controls></audio>
    <label>Or Upload File</label><input type="file" id="uploadFile" accept="audio/*">
    <button type="submit" class="submit">üíæ Save & Submit</button>
    <p id="status"></p>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/recorder-js@1.0.3/dist/recorder.min.js"></script>
<script>
const recordBtn = document.getElementById('recordBtn');
const uploadFile = document.getElementById('uploadFile');
const player = document.getElementById('player');
const form = document.getElementById('meetingForm');
const statusText = document.getElementById('status');
const webhookUrl = 'https://pb-n8n.planbmedia.co.th/webhook-test/voice';

let recorder, audioFile;

// Initialize Recorder.js
let audioContext;
recordBtn.onclick = async () => {
  if(recordBtn.classList.contains('recording')){
    // Stop
    const buffer = await recorder.stop();
    recorder.exportWAV(blob => {
      audioFile = new File([blob], 'meeting.wav', { type: 'audio/wav' });
      player.src = URL.createObjectURL(audioFile);
      recordBtn.textContent = 'üéô Start Recording';
      recordBtn.classList.remove('recording');
      recordBtn.classList.add('normal');
      uploadFile.value = '';
    });
  } else {
    // Start
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      recorder = new Recorder(audioContext.createMediaStreamSource(stream), { numChannels: 1 });
      recorder.record();
      recordBtn.textContent = '‚èπ Stop Recording';
      recordBtn.classList.remove('normal');
      recordBtn.classList.add('recording');
    } catch(err){
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏î‡πâ: '+err.message);
    }
  }
};

// Upload file handler
uploadFile.onchange = () => {
  if(uploadFile.files.length > 0){
    audioFile = uploadFile.files[0];
    player.src = URL.createObjectURL(audioFile);
    recordBtn.textContent = 'üéô Start Recording';
    recordBtn.classList.remove('recording');
    recordBtn.classList.add('normal');
  }
};

// Submit
form.onsubmit = async e => {
  e.preventDefault();
  const id = document.getElementById('userId').value.trim();
  const name = document.getElementById('userName').value.trim();
  const email = document.getElementById('userEmail').value.trim();

  if(!email.endsWith('@planbmedia.co.th')){
    alert('Email ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ @planbmedia.co.th'); return;
  }
  if(!audioFile){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á'); return;
  }

  const fd = new FormData();
  fd.append('ID', id);
  fd.append('Name', name);
  fd.append('Email', email);
  fd.append('file', audioFile);

  statusText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
  try {
    const res = await fetch(webhookUrl, { method:'POST', body: fd });
    const text = await res.text();
    if(res.ok){
      statusText.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
      form.reset();
      player.src = '';
      audioFile = null;
    } else {
      statusText.textContent = '‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+text;
    }
  } catch(err){
    statusText.textContent = '‚ùå Error: '+err.message;
  }
};
</script>
</body>
</html>
