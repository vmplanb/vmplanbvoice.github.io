<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Chat to n8n (MP3, Max 5min)</title>
<style>
body { font-family: Arial; display: flex; flex-direction: column; align-items: center; margin-top:30px; background:#f9f9f9;}
#recordButton,#uploadButton { width:120px;height:120px;border-radius:50%;border:none;font-size:16px;cursor:pointer;margin:10px;position:relative;outline:none;}
#recordButton{background:red;color:white;}
#uploadButton{background:#4CAF50;color:white;}
#recordButton.recording::after{content:'';position:absolute;top:-10px;left:-10px;width:140px;height:140px;border-radius:50%;border:2px solid red;animation:pulse 1s infinite;}
@keyframes pulse{0%{transform:scale(1);opacity:0.7}50%{transform:scale(1.2);opacity:0.3}100%{transform:scale(1);opacity:0.7}}
#timer{font-size:18px;margin-bottom:10px;}
#chat{width:500px;max-height:450px;border:1px solid #ccc;border-radius:10px;overflow-y:auto;padding:15px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.message{margin:10px 0;padding:12px 15px;border-radius:10px;word-wrap:break-word;white-space:pre-wrap;line-height:1.5;max-width:85%;}
.user{background:#daf1fc;text-align:right;align-self:flex-end;}
.bot{background:#f1f1f1;text-align:left;align-self:flex-start;}
.bot div{margin:4px 0;}
.bot strong{color:#333;}
</style>
</head>
<body>

<div id="timer">00:00 / 05:00</div>
<button id="recordButton">Record</button>
<input type="file" id="fileInput" style="display:none" accept="audio/*">
<button id="uploadButton">Upload Audio</button>
<div id="chat"></div>

<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<script>
const recordButton = document.getElementById('recordButton');
const uploadButton = document.getElementById('uploadButton');
const fileInput = document.getElementById('fileInput');
const chat = document.getElementById('chat');
const timerEl = document.getElementById('timer');

let mediaRecorder, audioChunks=[], recording=false, startTime, timerInterval;
let audioContext;
const MAX_RECORD_SEC = 300; // 5 นาที

recordButton.addEventListener('click', async ()=>{
  if(!recording){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.addEventListener("dataavailable", e=>audioChunks.push(e.data));

    mediaRecorder.addEventListener("stop", async ()=>{
      clearInterval(timerInterval);
      timerEl.textContent="00:00 / 05:00";
      const webmBlob = new Blob(audioChunks,{type:'audio/webm'});
      const mp3Blob = await convertWebMtoMP3(webmBlob);
      const url = URL.createObjectURL(mp3Blob);
      const a = document.createElement('a'); a.href=url; a.download=`voice_${new Date().toISOString()}.mp3`; a.click();
      sendAudioToN8n(mp3Blob,'voice.mp3');
    });

    mediaRecorder.start();
    recording=true;
    recordButton.classList.add('recording');
    recordButton.textContent='Stop';

    startTime=Date.now();
    timerInterval=setInterval(()=>{
      const elapsed=Math.floor((Date.now()-startTime)/1000);
      const min = String(Math.floor(elapsed/60)).padStart(2,'0');
      const sec = String(elapsed%60).padStart(2,'0');
      timerEl.textContent = `${min}:${sec} / 05:00`;

      if(elapsed>=MAX_RECORD_SEC){
        mediaRecorder.stop();
        recording=false;
        recordButton.classList.remove('recording');
        recordButton.textContent='Record';
      }
    },500);
  }else{
    mediaRecorder.stop();
    recording=false;
    recordButton.classList.remove('recording');
    recordButton.textContent='Record';
  }
});

uploadButton.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', async e=>{
  if(e.target.files.length>0){
    let file=e.target.files[0];
    addMessage(`User uploaded audio: ${file.name}`,'user');
    if(!['audio/mp3','audio/mpeg','audio/wav'].includes(file.type)){
      file = await convertFileToMP3(file);
    }
    sendAudioToN8n(file,file.name.endsWith('.mp3') ? file.name : 'upload.mp3');
  }
});

async function sendAudioToN8n(fileBlob,filename){
  const formData = new FormData();
  formData.append('file',fileBlob,filename);
  try{
    const response = await fetch('https://pb-n8n.planbmedia.co.th/webhook/voice',{method:'POST',body:formData});
    if(!response.ok) throw new Error(`HTTP status ${response.status}`);
    let data = await response.json();
    let message='';
    if(Array.isArray(data)&&data[0]?.output){message=data[0].output;}
    else if(data.text){message=data.text;}
    else if(typeof data==='string'){try{const p=JSON.parse(data);message=p.text||p.output||JSON.stringify(p);}catch(e){message=data;}}
    else{message=JSON.stringify(data);}
    addMessageStructured(message,'bot');
  }catch(err){console.error('Send audio error:',err); addMessage('Error sending to n8n: '+err.message,'bot');}
}

function addMessage(text,sender){
  const div=document.createElement('div');
  div.className=`message ${sender}`;
  div.innerHTML=text.replace(/\n/g,'<br>');
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function addMessageStructured(text,sender){
  const div=document.createElement('div');
  div.className=`message ${sender}`;
  const lines=text.split('\n');
  const html=lines.map(line=>{
    const parts=line.split(':');
    if(parts.length>=2){return `<div><strong>${parts[0].trim()}:</strong> ${parts.slice(1).join(':').trim()}</div>`;}
    else{return `<div>${line}</div>`;}
  }).join('');
  div.innerHTML=html;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

async function convertWebMtoMP3(blob){
  const arrayBuffer = await blob.arrayBuffer();
  if(!audioContext) audioContext=new (window.AudioContext||window.webkitAudioContext)();
  const buffer = await audioContext.decodeAudioData(arrayBuffer);
  const mp3Encoder = new lamejs.Mp3Encoder(buffer.numberOfChannels, buffer.sampleRate, 128);
  const samples = buffer.getChannelData(0);
  const mp3Data=[];
  const blockSize=1152;
  for(let i=0;i<samples.length;i+=blockSize){
    const chunk = samples.subarray(i,i+blockSize);
    const mp3buf = mp3Encoder.encodeBuffer(floatTo16BitPCM(chunk));
    if(mp3buf.length>0) mp3Data.push(mp3buf);
  }
  const mp3buf = mp3Encoder.flush();
  if(mp3buf.length>0) mp3Data.push(mp3buf);
  return new Blob(mp3Data,{type:'audio/mp3'});
}

async function convertFileToMP3(file){
  const arrayBuffer = await file.arrayBuffer();
  if(!audioContext) audioContext=new (window.AudioContext||window.webkitAudioContext)();
  const buffer = await audioContext.decodeAudioData(arrayBuffer);
  const mp3Encoder = new lamejs.Mp3Encoder(buffer.numberOfChannels, buffer.sampleRate, 128);
  const samples = buffer.getChannelData(0);
  const mp3Data=[];
  const blockSize=1152;
  for(let i=0;i<samples.length;i+=blockSize){
    const chunk = samples.subarray(i,i+blockSize);
    const mp3buf = mp3Encoder.encodeBuffer(floatTo16BitPCM(chunk));
    if(mp3buf.length>0) mp3Data.push(mp3buf);
  }
  const mp3buf = mp3Encoder.flush();
  if(mp3buf.length>0) mp3Data.push(mp3buf);
  return new Blob(mp3Data,{type:'audio/mp3'});
}

function floatTo16BitPCM(input){
  const output=new Int16Array(input.length);
  for(let i=0;i<input.length;i++){
    let s=Math.max(-1,Math.min(1,input[i]));
    output[i]=s<0?s*0x8000:s*0x7fff;
  }
  return output;
}
</script>
</body>
</html>
