<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voice → Transcription & Sales Summary</title>
  <style>
    /* Base */
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb;
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: linear-gradient(180deg,#f7fbff 0%, #f6f8fb 100%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      min-height:100vh;
    }
    .container{
      max-width:1000px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:20px;
      align-items:start;
    }

    /* Card */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 6px 24px rgba(16,24,40,0.06);
      padding:18px;
      border:1px solid rgba(16,24,40,0.04);
    }

    header.app{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:4px;
    }
    header.app h1{ margin:0; font-size:1.125rem; }
    header.app p{ margin:0; color:var(--muted); font-size:0.95rem }

    /* Left panel (main) */
    .main .controls{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .input, .select, .btn {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.06);
      background:linear-gradient(180deg, #fff, #fbfdff);
      font-size:0.95rem;
    }
    .input[type="file"]{ padding:8px; }
    .btn{
      background:var(--accent);
      color:white;
      cursor:pointer;
      border:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 6px 18px rgba(37,99,235,0.12);
    }
    .btn.secondary{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(37,99,235,0.12);
      box-shadow:none;
    }

    .field{
      margin-bottom:12px;
    }
    label{ display:block; font-size:0.85rem; color:var(--muted); margin-bottom:6px; }

    .log{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      background: linear-gradient(180deg,#f8fafc,#ffffff);
      border-radius:10px;
      padding:12px;
      font-size:0.9rem;
      color:#0b1220;
      min-height:120px;
      max-height:260px;
      overflow:auto;
      border:1px solid rgba(12,18,32,0.04);
    }

    /* Right panel (sidebar) */
    .sidebar h3{ margin:0 0 8px 0; font-size:0.95rem; }
    .meta{ display:flex; gap:10px; flex-direction:column; }
    .meta .kv{ display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:var(--glass); border:1px solid rgba(2,6,23,0.03); }
    .small{ font-size:0.85rem; color:var(--muted); }

    footer{ grid-column:1 / -1; margin-top:14px; text-align:center; color:var(--muted); font-size:0.85rem; }

    /* responsive */
    @media (max-width:920px){
      .container{ grid-template-columns: 1fr; padding:12px; }
      .sidebar{ order:2; }
      .main{ order:1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="app">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect x="0" y="0" width="24" height="24" rx="6" fill="#2563eb"/>
        <path d="M7 11h10M7 7h10M7 15h6" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div>
        <h1>Voice → Transcription & Sales Summary</h1>
        <p>อัปโหลดไฟล์เสียงหรือใส่ URL เพื่อถอดเสียงและสรุปเป็น Sales Activity</p>
      </div>
    </header>

    <section class="card main">
      <div class="controls">
        <div style="flex:1; min-width:220px">
          <div class="field">
            <label for="audioUrl">URL ไฟล์เสียง (Google Drive / S3 / URL ตรง)</label>
            <input id="audioUrl" class="input" placeholder="วางลิงก์ไฟล์เสียงที่นี่..." />
          </div>
          <div class="field">
            <label for="audioFile">หรือ อัปโหลดไฟล์เสียง</label>
            <input id="audioFile" type="file" accept="audio/*" class="input" />
          </div>
        </div>

        <div style="width:220px;">
          <div class="field">
            <label for="language">Language (optional)</label>
            <select id="language" class="select" style="width:100%">
              <option value="">auto-detect</option>
              <option value="th-TH">Thai (th-TH)</option>
              <option value="en-US">English (en-US)</option>
            </select>
          </div>

          <div style="display:flex;gap:8px;">
            <button id="sendBtn" class="btn">ส่งไปแปลง</button>
            <button id="clearBtn" class="btn secondary">ล้าง</button>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:280px">
          <label class="small">Log / Response</label>
          <pre id="log" class="log">ยังไม่มีการส่งงาน</pre>
        </div>

        <div style="width:260px;">
          <label class="small">Quick actions</label>
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="copySessionBtn" class="btn secondary" style="flex:1">คัดลอก sessionId</button>
            <button id="resetSessionBtn" class="btn secondary" style="flex:1">สร้างใหม่</button>
          </div>
          <div class="card" style="padding:12px; margin-top:8px;">
            <h3>Session</h3>
            <div class="meta">
              <div class="kv"><div class="small">sessionId</div><div id="sessionDisplay" style="font-family:mono"></div></div>
              <div class="kv"><div class="small">Endpoint</div><div style="font-size:0.95rem;color:var(--muted)">/webhook (ตัวอย่าง)</div></div>
            </div>
          </div>
        </div>
      </div>

    </section>

    <aside class="card sidebar">
      <h3>การตั้งค่า / คำแนะนำ</h3>
      <p class="small" style="margin-bottom:10px">
        ตัวอย่างนี้จะส่งคำขอ <code>POST</code> เป็น JSON ไปยัง endpoint ที่คุณกำหนด (ตัวอย่าง: <code>/webhook</code>) โดยมี <strong>X-Session-Id</strong> ใน header และมี field <code>sessionId</code> ใน body ด้วย
      </p>

      <h3>ตัวอย่าง payload</h3>
      <pre class="small" style="white-space:pre-wrap; background:#fbfdff; padding:10px; border-radius:8px; border:1px solid rgba(2,6,23,0.03);">
{
  "sessionId": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "audioUrl": "...",
  "language": "th-TH"
}
      </pre>

      <h3 style="margin-top:12px">ข้อควรระวัง</h3>
      <ul class="small" style="padding-left:18px; margin:8px 0;">
        <li>ถ้าใช้ Google Drive ให้ตั้งไฟล์เป็น public หรือแชร์เป็น anyone with link</li>
        <li>ปรับ endpoint ให้รองรับ header <code>X-Session-Id</code></li>
      </ul>

    </aside>

    <footer class="small card" style="padding:10px;">
      สร้างโดยระบบ — ปรับแต่ง endpoint และ logic ของคุณได้ตามต้องการ
    </footer>
  </div>

  <script>
    // --- Session ID utilities ---
    function uuidv4() {
      // simple RFC4122 v4 UUID generator
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = crypto.getRandomValues(new Uint8Array(1))[0] % 16;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // try to use sessionId from server (if injected as window.SESSION_ID) else localStorage
    const SESSION_KEY = 'app_session_id_v1';
    function getSessionId(){
      // if backend injects window.SESSION_ID (optional), use it
      if(window.SESSION_ID && typeof window.SESSION_ID === 'string' && window.SESSION_ID.length>10) {
        try { localStorage.setItem(SESSION_KEY, window.SESSION_ID); } catch(e){}
        return window.SESSION_ID;
      }
      let s = localStorage.getItem(SESSION_KEY);
      if(!s){
        s = uuidv4();
        try { localStorage.setItem(SESSION_KEY, s); } catch(e){}
      }
      return s;
    }
    function resetSessionId(){
      const s = uuidv4();
      localStorage.setItem(SESSION_KEY, s);
      renderSession();
    }

    // --- DOM ---
    const audioUrlEl = document.getElementById('audioUrl');
    const audioFileEl = document.getElementById('audioFile');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const logEl = document.getElementById('log');
    const sessionDisplay = document.getElementById('sessionDisplay');
    const copySessionBtn = document.getElementById('copySessionBtn');
    const resetSessionBtn = document.getElementById('resetSessionBtn');

    function renderSession(){
      sessionDisplay.textContent = getSessionId();
    }
    renderSession();

    copySessionBtn.addEventListener('click', async () => {
      const s = getSessionId();
      try {
        await navigator.clipboard.writeText(s);
        toast('คัดลอก sessionId เรียบร้อย');
      } catch(e){
        toast('คัดลอกไม่สำเร็จ');
      }
    });
    resetSessionBtn.addEventListener('click', () => {
      resetSessionId();
      toast('สร้าง sessionId ใหม่แล้ว');
    });

    clearBtn.addEventListener('click', () => {
      audioUrlEl.value = '';
      audioFileEl.value = '';
      language.value = '';
      log('ล้างข้อมูลแล้ว');
    });

    function log(msg){
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
    }

    function toast(msg){
      // simple ephemeral notification
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed';
      el.style.right = '18px';
      el.style.bottom = '18px';
      el.style.background = '#0f172a';
      el.style.color = '#fff';
      el.style.padding = '10px 14px';
      el.style.borderRadius = '10px';
      el.style.boxShadow = '0 8px 30px rgba(2,6,23,0.2)';
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 2600);
    }

    // --- Send logic ---
    async function sendJob(){
      const sessionId = getSessionId();
      const endpoint = 'https://pb-n8n.planbmedia.co.th/webhook/voice'; // <-- เปลี่ยนเป็น endpoint จริงของคุณ
      const audioUrl = audioUrlEl.value.trim();
      const lang = (document.getElementById('language') || {}).value || '';

      // if user selected a file, upload it as form-data or convert to base64 depending on backend support
      const file = audioFileEl.files && audioFileEl.files[0];

      log('เตรียมส่งงาน...');

      try {
        let fetchOptions = {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'X-Session-Id': sessionId
            // 'Content-Type' assigned below depending on body type
          },
        };

        if(file){
          // send as multipart/form-data
          const fd = new FormData();
          fd.append('sessionId', sessionId);
          fd.append('language', lang);
          fd.append('audioFile', file, file.name);
          // optionally include a metadata JSON
          fd.append('meta', JSON.stringify({source: 'web-ui'}));

          fetchOptions.body = fd;
          // browser will set Content-Type with boundary
        } else if (audioUrl){
          // send as JSON
          fetchOptions.headers['Content-Type'] = 'application/json';
          fetchOptions.body = JSON.stringify({
            sessionId,
            audioUrl,
            language: lang || undefined,
            source: 'web-ui'
          });
        } else {
          log('กรุณาใส่ URL หรืออัปโหลดไฟล์ก่อนส่ง');
          toast('ต้องใส่ URL หรืออัปโหลดไฟล์');
          return;
        }

        log(`ส่งไปยัง ${endpoint} (sessionId: ${sessionId})`);
        const res = await fetch(endpoint, fetchOptions);
        if(!res.ok){
          const text = await res.text().catch(()=>null);
          log(`Server ตอบ error: ${res.status} ${res.statusText} ${text ? ' - ' + text : ''}`);
          toast('การส่งล้มเหลว');
          return;
        }
        const data = await res.json().catch(()=>null);
        log('ได้รับ response จาก server');
        if(data) log(JSON.stringify(data, null, 2));
        toast('ส่งสำเร็จ');
      } catch(err){
        console.error(err);
        log('เกิดข้อผิดพลาด: ' + (err && err.message ? err.message : String(err)));
        toast('ข้อผิดพลาดขณะส่ง');
      }
    }

    sendBtn.addEventListener('click', () => {
      sendJob();
    });

    // optional: if server injects window.SESSION_ID before this script runs, render it
    if(window.SESSION_ID) renderSession();

    // allow pressing Enter in audioUrl to send
    audioUrlEl.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ sendJob(); } });

  </script>
</body>
</html>
